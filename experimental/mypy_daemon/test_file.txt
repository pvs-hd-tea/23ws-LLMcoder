import json
import os
import time

import torch
from bs4 import BeautifulSoup
from langchain.callbacks.manager import CallbackManager
from langchain.callbacks.streaming_stdout import StreamingStdOutCallbackHandler
from langchain.document_loaders import DirectoryLoader, JSONLoader
from langchain.embeddings import OllamaEmbeddings  # We can also try Ollama embeddings
from langchain.embeddings import GPT4AllEmbeddings
from langchain.llms import Ollama
from langchain.text_splitter import RecursiveCharacterTextSplitter
# Embed and store
from langchain.vectorstores.elasticsearch import ElasticsearchStore
from tqdm import tqdm

device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")

# pip install jq
schema = {
    'jq_schema': '.text'
}

es = get_es_connection()

REINDEX = False

# pip install gpt4all
# Needs Ubuntu > 22.04 because of glibc

if REINDEX:
    # Clear the index
    es.indices.delete(index="eurlex-langchain", ignore=[400, 404])

    start_time = time.time()
    vectorstore = ElasticsearchStore(np.array([0.0, 0.0, 0.0, 0.0, 0.0]), es, index="eurlex-langchain", schema=schema)